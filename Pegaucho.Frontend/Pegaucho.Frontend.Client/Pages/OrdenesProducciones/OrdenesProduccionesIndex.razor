@page "/OrdenesProducciones"
@using Pegaucho.Shared.DTOs
@using Pegaucho.Frontend.Client.Repositories
@inject IOrdenProduccionRepository OrdenProduccionRepository
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<style>
    .header-container {
        background-color: #3e3e9f;
        color: white;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .header-title {
        font-size: 2rem;
        font-weight: 400;
        margin: 0;
    }

    .header-icons {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .search-section {
        margin-bottom: 1.5rem;
        padding: 0 2rem;
    }

    .datos-producto-card {
        background-color: #d3d3d3;
        padding: 1.5rem;
        margin: 0 2rem 1.5rem 2rem;
        border-radius: 4px;
        border: 3px solid #4db8e8;
    }

    .datos-header {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #363636;
    }

    .form-row {
        display: flex;
        gap: 2rem;
        margin-bottom: 1rem;
        align-items: flex-end;
    }

    .form-field {
        flex: 1;
    }

    .button-group {
        display: flex;
        gap: 1rem;
        flex-direction: column;
        min-width: 180px;
    }

    .table-container {
        margin: 0 2rem;
        border: 2px solid #3e3e9f;
        border-radius: 4px;
        overflow: hidden;
    }

    .action-buttons {
        display: flex;
        justify-content: space-between;
        padding: 0 2rem;
        margin-top: 1.5rem;
    }

    .btn-primary {
        background-color: #3e3e9f !important;
    }

    .btn-secondary {
        background-color: #6c757d !important;
    }

    .scroll-indicator {
        text-align: right;
        padding-right: 2rem;
        color: #666;
        font-size: 1.5rem;
    }
</style>

<!-- Header -->
<div class="header-container">
    <div style="display: flex; align-items: center; gap: 1rem;">
        <MudIcon Icon="@Icons.Material.Filled.Inventory2" Size="Size.Large" />
        <h1 class="header-title">Preflex línea Pegaucho</h1>
    </div>
    <div class="header-icons">
        <MudIconButton Icon="@Icons.Material.Filled.Person" Color="Color.Inherit" Size="Size.Large" />
    </div>
</div>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Style="padding: 0;">
    <!-- Título de sección -->
    <div style="text-align: center; margin-bottom: 2rem;">
        <MudText Typo="Typo.h4" Style="font-weight: 300;">Producción</MudText>
    </div>

    <!-- Búsqueda -->
    <div style="padding: 0 2rem; margin-bottom: 1.5rem;">
        <MudText Typo="Typo.body1" Style="margin-bottom: 0.5rem;"><b>Buscar:</b></MudText>
        <MudTextField @bind-Value="busqueda"
                      Placeholder="Cédula, nombre..."
                      Variant="Variant.Outlined"
                      Adornment="Adornment.End"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Margin="Margin.Dense"
                      Style="max-width: 300px; background-color: white;" />
    </div>

    <!-- Datos del producto -->
    <div class="datos-producto-card">
        <div class="datos-header">Datos del producto:</div>

        <div class="form-row">
            <div class="form-field">
                <MudText Typo="Typo.body2" Style="margin-bottom: 0.3rem;">Código producto:</MudText>
                <MudNumericField @bind-Value="ordenProduccion.CodProd"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Style="background-color: white;" />
            </div>

            <div class="form-field">
                <MudText Typo="Typo.body2" Style="margin-bottom: 0.3rem;">Cantidad:</MudText>
                <MudNumericField @bind-Value="ordenProduccion.Cantidad"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Style="background-color: white;" />
            </div>

            <div class="form-field">
                <MudText Typo="Typo.body2" Style="margin-bottom: 0.3rem;">Prioridad:</MudText>
                <MudTextField @bind-Value="ordenProduccion.Prioridad"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Style="background-color: white;" />
            </div>

            <div class="form-field">
                <MudText Typo="Typo.body2" Style="margin-bottom: 0.3rem;">Tiempo estimado:</MudText>
                <MudTextField @bind-Value="ordenProduccion.TiempoEstimado"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Style="background-color: white;" />
            </div>

            <div class="button-group">
                <MudButton Variant="Variant.Filled"
                           Class="btn-primary"
                           FullWidth="true"
                           OnClick="AgregarProducto">
                    Agregar producto
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Class="btn-primary"
                           FullWidth="true"
                           OnClick="EliminarProducto">
                    Eliminar producto
                </MudButton>
            </div>
        </div>

        <div class="form-row">
            <div class="form-field">
                <MudText Typo="Typo.body2" Style="margin-bottom: 0.3rem;">Maquinaria:</MudText>
                <MudSelect @bind-Value="ordenProduccion.MaquinaProd"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Style="background-color: white;">
                    <MudSelectItem Value="@("pistón")">pistón</MudSelectItem>
                    <MudSelectItem Value="@("peristáltica")">peristáltica</MudSelectItem>
                    <MudSelectItem Value="@("volumétrica")">volumétrica</MudSelectItem>
                    <MudSelectItem Value="@("gravimétrica")">gravimétrica</MudSelectItem>
                </MudSelect>
            </div>
            <div class="form-field">
                <MudText Typo="Typo.body2" Style="margin-bottom: 0.3rem;">Materias primas:</MudText>
                <MudTextField @bind-Value="ordenProduccion.MatPrima"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Style="background-color: white;" />
            </div>
            <div class="form-field"></div>
            <div class="button-group"></div>
        </div>
    </div>

    <!-- Tabla -->
    <div class="table-container">
        <MudTable Items="@ordenes"
                  Hover="true"
                  Striped="true"
                  Dense="true"
                  Style="background-color: #e8e8e8;">
            <HeaderContent>
                <MudTh Style="background-color: #3e3e9f; color: white; text-align: center;">Código</MudTh>
                <MudTh Style="background-color: #3e3e9f; color: white; text-align: center;">Producto</MudTh>
                <MudTh Style="background-color: #3e3e9f; color: white; text-align: center;">Cantidad</MudTh>
                <MudTh Style="background-color: #3e3e9f; color: white; text-align: center;">Materias primas</MudTh>
                <MudTh Style="background-color: #3e3e9f; color: white; text-align: center;">Maquinaria</MudTh>
                <MudTh Style="background-color: #3e3e9f; color: white; text-align: center;">Tiempo estimando</MudTh>
                <MudTh Style="background-color: #3e3e9f; color: white; text-align: center;">costos</MudTh>
                <MudTh Style="background-color: #3e3e9f; color: white; text-align: center;">Fecha</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Código" Style="text-align: center;">@context.CodProd</MudTd>
                <MudTd DataLabel="Producto" Style="text-align: center;">@context.Nombre</MudTd>
                <MudTd DataLabel="Cantidad" Style="text-align: center;">@context.Cantidad</MudTd>
                <MudTd DataLabel="Materias primas" Style="text-align: center;">@context.MatPrima</MudTd>
                <MudTd DataLabel="Maquinaria" Style="text-align: center;">@context.MaquinaProd</MudTd>
                <MudTd DataLabel="Tiempo estimando" Style="text-align: center;">@context.TiempoEstimado</MudTd>
                <MudTd DataLabel="costos" Style="text-align: center;">@context.Costo</MudTd>
                <MudTd DataLabel="Fecha" Style="text-align: center;">@context.Fecha?.ToString("dd/MM/yyyy")</MudTd>
            </RowTemplate>
        </MudTable>
    </div>

    <!-- Indicador de scroll -->
    <div class="scroll-indicator">
        <span>↓</span>
    </div>

    <!-- Botones de acción -->
    <div class="action-buttons">
        <MudButton Variant="Variant.Filled"
                   Class="btn-primary"
                   Size="Size.Large"
                   Style="min-width: 150px;"
                   OnClick="Regresar">
            Regresar
        </MudButton>

        <div style="display: flex; gap: 1rem;">
            <MudButton Variant="Variant.Filled"
                       Class="btn-primary"
                       Size="Size.Large"
                       Style="min-width: 150px;"
                       OnClick="GenerarOrden"
                       Disabled="@loading">
                @if (loading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                }
                else
                {
                    <span>Generar orden</span>
                }
            </MudButton>

            <MudButton Variant="Variant.Filled"
                       Class="btn-secondary"
                       Size="Size.Large"
                       Style="min-width: 150px;"
                       OnClick="Cancelar">
                Cancelar
            </MudButton>
        </div>
    </div>
</MudContainer>

@code {
    private OrdenProduccionDTO ordenProduccion = new();
    private List<OrdenProduccionDTO> ordenes = new();
    private string busqueda = "";
    private bool loading = false;

    protected override async Task OnInitializedAsync()
    {
        ordenProduccion.IdOrdenPanel = 1;
        ordenProduccion.IdLogin = 1;
        await CargarOrdenes();
    }

    private async Task CargarOrdenes()
    {
        try
        {
            var response = await OrdenProduccionRepository.GetAsync();
            if (!response.Error && response.Response != null)
            {
                ordenes = response.Response.ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar órdenes: {ex.Message}", Severity.Error);
        }
    }

    private void AgregarProducto()
    {
        if (ordenProduccion.CodProd > 0 && ordenProduccion.Cantidad > 0)
        {
            var nuevaOrden = new OrdenProduccionDTO
                {
                    CodProd = ordenProduccion.CodProd,
                    Cantidad = ordenProduccion.Cantidad,
                    MaquinaProd = ordenProduccion.MaquinaProd,
                    Nombre = $"Colbon",
                    MatPrima = ordenProduccion.MatPrima,
                    Prioridad = "Pendiente",
                    TiempoEstimado = ordenProduccion.TiempoEstimado,
                    Fecha = DateTime.Now,
                    IdOrdenPanel = 1,
                    IdLogin = 1
                };

            ordenes.Add(nuevaOrden);
            LimpiarFormulario();
            Snackbar.Add("Producto agregado a la lista", Severity.Success);
        }
        else
        {
            Snackbar.Add("Complete los campos requeridos", Severity.Warning);
        }
    }

    private void EliminarProducto()
    {
        if (ordenes.Any())
        {
            ordenes.RemoveAt(ordenes.Count - 1);
            Snackbar.Add("Último producto eliminado", Severity.Info);
        }
    }

    private async Task GenerarOrden()
    {
        if (!ordenes.Any())
        {
            Snackbar.Add("Agregue al menos un producto antes de generar la orden", Severity.Warning);
            return;
        }

        loading = true;
        try
        {
            foreach (var orden in ordenes)
            {
                await OrdenProduccionRepository.PostAsync(orden);
            }

            Snackbar.Add("✓ Órdenes de producción generadas exitosamente", Severity.Success);
            ordenes.Clear();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al generar órdenes: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void LimpiarFormulario()
    {
        ordenProduccion = new OrdenProduccionDTO
            {
                IdOrdenPanel = 1,
                IdLogin = 1
            };
    }

    private void Regresar()
    {
        NavigationManager.NavigateTo("/");
    }

    private void Cancelar()
    {
        ordenes.Clear();
        LimpiarFormulario();
        Snackbar.Add("Operación cancelada", Severity.Info);
    }
}